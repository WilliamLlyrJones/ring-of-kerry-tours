<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Ring of Kerry Adventure - Personalized Itinerary</title>
    <meta name="description" content="Your personalized Ring of Kerry itinerary, created by AI and tailored to your preferences.">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .back-link {
            color: #4a7c59;
            text-decoration: none;
            margin-bottom: 20px;
            display: inline-block;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .back-link:hover {
            color: #2d5a3d;
        }
        
        .header h1 {
            font-size: 2.5em;
            color: #2d5a3d;
            margin-bottom: 10px;
        }
        
        .header .summary {
            font-size: 1.2em;
            color: #666;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .special-requirements-section {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border-radius: 12px;
            border-left: 4px solid #4a7c59;
        }
        
        .requirements-title {
            font-weight: 600;
            color: #2d5a3d;
            font-size: 1.1em;
            margin-bottom: 12px;
        }
        
        .requirements-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .requirement-highlight {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            border: 1px solid;
        }
        
        .requirement-highlight.dietary {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }
        
        .requirement-highlight.accessibility {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        
        .requirement-highlight.special {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        
        .requirement-highlight.style {
            background: #e2e3e5;
            color: #383d41;
            border-color: #d6d8db;
        }
        
        .requirement-highlight.accommodation {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        
        .requirements-note {
            font-size: 0.9em;
            color: #2d5a3d;
            font-style: italic;
            margin-top: 8px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #4a7c59;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3d6449;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 124, 89, 0.3);
        }
        
        .btn-secondary {
            background: white;
            color: #4a7c59;
            border: 2px solid #4a7c59;
        }
        
        .btn-secondary:hover {
            background: #4a7c59;
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            color: #666;
            border: 2px solid #ddd;
        }
        
        .btn-outline:hover {
            background: #f8f9fa;
            border-color: #4a7c59;
            color: #4a7c59;
        }

        /* Map section styles */
        .map-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .map-title {
            font-size: 1.5em;
            color: #2d5a3d;
            font-weight: 600;
        }
        
        .map-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .map-btn {
            padding: 8px 16px;
            border: 2px solid #4a7c59;
            border-radius: 20px;
            background: white;
            color: #4a7c59;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .map-btn:hover {
            background: #4a7c59;
            color: white;
        }
        
        .map-btn.active {
            background: #4a7c59;
            color: white;
        }
        
        #map {
            height: 400px;
            width: 100%;
            border-radius: 15px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
        }
        
        .map-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            color: #666;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .itinerary-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            line-height: 1.8;
        }
        
        .itinerary-content h2 {
            color: #2d5a3d;
            font-size: 1.8em;
            margin: 40px 0 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border-left: 5px solid #4a7c59;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .itinerary-content h2:first-child {
            margin-top: 0;
        }
        
        .itinerary-content h3 {
            color: #4a7c59;
            font-size: 1.3em;
            margin: 25px 0 15px 0;
            padding: 15px 20px;
            background: #f0f8ff;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }
        
        .itinerary-content h4 {
            color: #2d5a3d;
            font-size: 1.2em;
            margin: 20px 0 8px 0;
        }
        
        .itinerary-content p {
            margin-bottom: 15px;
            color: #444;
            padding-left: 20px;
        }
        
        .itinerary-content strong {
            color: #2d5a3d;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 40px 0;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
        }
        
        .spinner {
            border: 4px solid #e0e0e0;
            border-top: 4px solid #4a7c59;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        
        .share-url {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ddd;
            margin: 20px 0;
            word-break: break-all;
            font-family: monospace;
        }
        
        .download-options {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .download-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .download-option:hover {
            border-color: #4a7c59;
            background-color: #f8f9fa;
        }
        
        .tips-section {
            background: #f0f8ff;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border-left: 4px solid #007bff;
        }
        
        .tips-section h3 {
            color: #007bff;
            margin-bottom: 15px;
        }
        
        .tip-list {
            list-style: none;
            padding: 0;
        }
        
        .tip-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }
        
        .tip-list li::before {
            content: '💡';
            position: absolute;
            left: 0;
        }
        
        .disclaimer-section {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border-left: 4px solid #f39c12;
        }
        
        .disclaimer-section h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .disclaimer-content {
            color: #856404;
            line-height: 1.6;
        }
        
        .disclaimer-content p {
            margin-bottom: 15px;
        }
        
        .disclaimer-content ul {
            margin: 15px 0;
            padding-left: 20px;
        }
        
        .disclaimer-content li {
            margin-bottom: 8px;
        }
        
        .disclaimer-content strong {
            color: #7d4e00;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .itinerary-content {
                padding: 25px;
            }
            
            .map-section {
                padding: 20px;
            }
            
            #map {
                height: 300px;
            }
            
            .map-header {
                flex-direction: column;
                text-align: center;
            }
            
            .map-legend {
                justify-content: center;
                gap: 15px;
            }
        }
    </style>
    <!-- Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxna1lvu0xrFFHw2t0uTNHqZMDYFAONJs&callback=initGoogleMaps&libraries=geometry"></script>
</head>
<body>
    <div class="container">
        <a href="/planner" class="back-link">← Back to Trip Planner</a>
        
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <h2>Loading your itinerary...</h2>
            <p>Please wait while we retrieve your personalized Ring of Kerry adventure.</p>
        </div>
        
        <div id="errorState" class="error-message" style="display: none;">
            <h2>Oops! Something went wrong</h2>
            <p>We could not load your itinerary. This might happen if you navigated directly to this page without completing the questionnaire.</p>
            <a href="/planner" class="btn btn-primary" style="margin-top: 15px;">Start New Trip Plan</a>
        </div>
        
        <div id="mainContent" style="display: none;">
            <div class="header">
                <h1>🍀 Your Ring of Kerry Adventure</h1>
                <div class="summary" id="tripSummary">
                    <!-- Summary will be populated -->
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="showDownloadOptions()">📱 Download Itinerary</button>
                <button class="btn btn-secondary" onclick="showShareModal()">📤 Share</button>
                <button class="btn btn-outline" onclick="printItinerary()">🖨️ Print</button>
            </div>
            
            <!-- Interactive Map Section -->
            <div class="map-section">
                <div class="map-header">
                    <h2 class="map-title">🗺️ Your Route Map</h2>
                    <div class="map-controls">
                        <button class="map-btn active" onclick="showAllDays()" id="allDaysBtn">All Days</button>
                        <button class="map-btn" onclick="showDay(1)" id="day1Btn">Day 1</button>
                        <button class="map-btn" onclick="showDay(2)" id="day2Btn" style="display: none;">Day 2</button>
                        <button class="map-btn" onclick="showDay(3)" id="day3Btn" style="display: none;">Day 3</button>
                        <button class="map-btn" onclick="showDay(4)" id="day4Btn" style="display: none;">Day 4</button>
                        <button class="map-btn" onclick="showDay(5)" id="day5Btn" style="display: none;">Day 5</button>
                        <button class="map-btn" onclick="showDay(6)" id="day6Btn" style="display: none;">Day 6</button>
                        <button class="map-btn" onclick="showDay(7)" id="day7Btn" style="display: none;">Day 7</button>
                        <button class="map-btn" onclick="toggleSatellite()" id="satelliteBtn">Satellite</button>
                    </div>
                </div>
                <div id="map">
                    🗺️ Loading interactive map...
                </div>
                <div class="map-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4444;"></div>
                        <span>Day 1 Stops</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4444ff;"></div>
                        <span>Day 2 Stops</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #44ff44;"></div>
                        <span>Day 3+ Stops</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff8800;"></div>
                        <span>Accommodations</span>
                    </div>
                </div>
            </div>
            
            <div class="itinerary-content" id="itineraryContent">
                <!-- Itinerary will be populated -->
            </div>
            
            <div class="tips-section">
                <h3>💡 Insider Tips for Your Trip</h3>
                <ul class="tip-list">
                    <li><strong>Driving:</strong> Irish roads are narrower than American roads. Take your time and use passing places courteously.</li>
                    <li><strong>Weather:</strong> Irish weather can be unpredictable. Pack layers and a waterproof jacket.</li>
                    <li><strong>Photography:</strong> Best light is usually in the morning (golden hour) and late afternoon.</li>
                    <li><strong>Dining:</strong> Make dinner reservations, especially on weekends. Irish dinners are typically served 6-9 PM.</li>
                    <li><strong>Currency:</strong> Ireland uses the Euro (€). Most places accept cards, but carry some cash for small purchases.</li>
                    <li><strong>Tipping:</strong> 10-15% is standard for good service in restaurants.</li>
                </ul>
            </div>

            <!-- Important Disclaimer Section -->
            <div class="disclaimer-section">
                <h3>⚠️ Important Disclaimer</h3>
                <div class="disclaimer-content">
                    <p><strong>These itinerary suggestions are for informational purposes only.</strong> Ring of Kerry Tours provides these recommendations as general guidance to help plan your trip.</p>
                    
                    <p><strong>You must verify all information before your visit:</strong></p>
                    <ul>
                        <li>Restaurant opening hours, menus, and dietary accommodation capabilities</li>
                        <li>Attraction opening times, admission fees, and accessibility features</li>
                        <li>Road conditions, parking availability, and route accessibility</li>
                        <li>Weather conditions and seasonal activity availability</li>
                        <li>Booking requirements and contact information</li>
                    </ul>
                    
                    <p><strong>Liability Limitation:</strong> Ring of Kerry Tours accepts no liability for any errors, omissions, or changes in the information provided. Businesses may close, change hours, modify accessibility features, or alter services without notice. Travelers are responsible for confirming all details independently before making any bookings or visiting locations.</p>
                    
                    <p><strong>Special Requirements:</strong> If you have specific dietary, accessibility, or other special requirements, please contact venues directly to confirm their current ability to accommodate your needs.</p>
                    
                    <p>Always prioritize your safety and comfort when making travel decisions.</p>
                </div>
            </div>
        </div>
        
        <!-- Share Modal -->
        <div id="shareModal" class="modal">
            <div class="modal-content">
                <h3>Share Your Itinerary</h3>
                <p>Copy this link to share your personalized Ring of Kerry itinerary:</p>
                <div class="share-url" id="shareUrl">
                    <!-- URL will be populated -->
                </div>
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="copyShareLink()">Copy Link</button>
                    <button class="btn btn-outline" onclick="closeShareModal()">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Download Options Modal -->
        <div id="downloadModal" class="modal">
            <div class="modal-content">
                <h3>Download Your Itinerary</h3>
                <p>Choose your preferred format:</p>
                <div class="download-options">
                    <div class="download-option" onclick="downloadAsPDF()">
                        <div>
                            <strong>📄 PDF Document</strong>
                            <div style="font-size: 0.9em; color: #666;">Professional format, easy to print</div>
                        </div>
                        <span>→</span>
                    </div>
                    <div class="download-option" onclick="downloadAsText()">
                        <div>
                            <strong>📝 Text File</strong>
                            <div style="font-size: 0.9em; color: #666;">Simple text format, works everywhere</div>
                        </div>
                        <span>→</span>
                    </div>
                    <div class="download-option" onclick="emailItinerary()">
                        <div>
                            <strong>📧 Email to Myself</strong>
                            <div style="font-size: 0.9em; color: #666;">Send to your email address</div>
                        </div>
                        <span>→</span>
                    </div>
                </div>
                <button class="btn btn-outline" onclick="closeDownloadModal()" style="margin-top: 20px;">Close</button>
            </div>
        </div>
    </div>

    <script>
        console.log("Script starting");
        
        var currentItinerary = null;
        var currentUserData = null;
        var itineraryId = null;
        
        // Google Maps variables
        var map = null;
        var directionsService = null;
        var directionsRenderer = null;
        var markers = [];
        var routeColors = ['#ff4444', '#4444ff', '#44ff44', '#ff8800', '#8844ff', '#44ffff', '#ff44ff'];
        var isSatelliteView = false;
        var extractedLocations = [];
        var currentDayFilter = 'all';
        
        // Ring of Kerry key locations with coordinates
        var ringOfKerryLocations = {
            'killarney': { lat: 52.0599, lng: -9.5044, name: 'Killarney' },
            'kenmare': { lat: 51.8833, lng: -9.5833, name: 'Kenmare' },
            'sneem': { lat: 51.8333, lng: -9.9000, name: 'Sneem' },
            'waterville': { lat: 51.8333, lng: -10.1667, name: 'Waterville' },
            'cahersiveen': { lat: 51.9489, lng: -10.2225, name: 'Cahersiveen' },
            'glenbeigh': { lat: 52.1167, lng: -9.9167, name: 'Glenbeigh' },
            'killorglin': { lat: 52.1167, lng: -9.8000, name: 'Killorglin' },
            'ladies view': { lat: 51.9967, lng: -9.5733, name: 'Ladies View' },
            'moll gap': { lat: 51.9333, lng: -9.6333, name: 'Molls Gap' },
            'molls gap': { lat: 51.9333, lng: -9.6333, name: 'Molls Gap' },
            'gap of dunloe': { lat: 52.0333, lng: -9.6167, name: 'Gap of Dunloe' },
            'portmagee': { lat: 51.8833, lng: -10.3833, name: 'Portmagee' },
            'valentia island': { lat: 51.9333, lng: -10.3500, name: 'Valentia Island' },
            'skellig michael': { lat: 51.7719, lng: -10.5422, name: 'Skellig Michael' },
            'kerry cliffs': { lat: 51.8833, lng: -10.4000, name: 'Kerry Cliffs' },
            'ring of skellig': { lat: 51.8500, lng: -10.3500, name: 'Ring of Skellig' },
            'staigue fort': { lat: 51.7833, lng: -9.9833, name: 'Staigue Fort' },
            'derrynane beach': { lat: 51.7500, lng: -10.1167, name: 'Derrynane Beach' },
            'muckross house': { lat: 52.0167, lng: -9.5167, name: 'Muckross House' },
            'ross castle': { lat: 52.0333, lng: -9.5333, name: 'Ross Castle' },
            'torc waterfall': { lat: 52.0000, lng: -9.5500, name: 'Torc Waterfall' },
            'caherdaniel': { lat: 51.7667, lng: -10.1000, name: 'Caherdaniel' },
            'ballycarbery castle': { lat: 51.9547, lng: -10.2272, name: 'Ballycarbery Castle' },
            'daniel o\'connell circle': { lat: 51.7667, lng: -10.1000, name: 'Daniel O\'Connell Circle' },
            'kells bay': { lat: 51.8167, lng: -10.1167, name: 'Kells Bay' }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded - starting loadItinerary");
            loadItinerary();
        });
        
        // Google Maps initialization callback
        function initGoogleMaps() {
            console.log("Google Maps API loaded");
            if (currentUserData && currentItinerary) {
                setTimeout(initializeMap, 100);
            }
        }
        
        function loadItinerary() {
            console.log("loadItinerary function called");
            
            try {
                var urlParams = new URLSearchParams(window.location.search);
                var sharedId = urlParams.get('id');
                
                if (sharedId) {
                    console.log("Found shared ID: " + sharedId);
                    loadSharedItinerary(sharedId);
                    return;
                }
                
                var itineraryData = sessionStorage.getItem('generatedItinerary');
                var userData = sessionStorage.getItem('userData');
                
                console.log("Session storage check:");
                console.log("Has itinerary: " + (!!itineraryData));
                console.log("Has userData: " + (!!userData));
                
                if (!itineraryData || !userData) {
                    console.log("No session data - showing error");
                    showError();
                    return;
                }
                
                var itinerary = JSON.parse(itineraryData);
                currentUserData = JSON.parse(userData);
                currentItinerary = itinerary.itinerary || itinerary;
                itineraryId = itinerary.itineraryId;
                
                console.log("Data parsed successfully");
                displayItinerary();
                
            } catch (error) {
                console.error("Error in loadItinerary: " + error.message);
                showError();
            }
        }
        
        function loadSharedItinerary(id) {
            console.log("loadSharedItinerary called with: " + id);
            
            fetch('/.netlify/functions/get-itinerary/' + id)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Itinerary not found');
                    }
                    return response.json();
                })
                .then(function(data) {
                    currentItinerary = data.itinerary.itineraryText;
                    currentUserData = data.itinerary.userData;
                    itineraryId = data.itinerary.id;
                    
                    console.log("Shared itinerary loaded");
                    displayItinerary();
                })
                .catch(function(error) {
                    console.error("Error loading shared itinerary: " + error.message);
                    showError();
                });
        }
        
        function displayItinerary() {
            console.log("displayItinerary called");
            
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            populateSummary(currentUserData);
            populateItinerary(currentItinerary);
            setupDayButtons();
            
            // Initialize map if Google Maps is available
            if (typeof google !== 'undefined') {
                initializeMap();
            } else {
                console.log("Google Maps not loaded yet, will initialize when ready");
            }
        }
        
        function setupDayButtons() {
            var duration = parseInt(currentUserData.duration) || 3;
            console.log("Setting up day buttons for " + duration + " days");
            
            // Show day buttons based on duration
            for (var i = 1; i <= Math.min(duration, 7); i++) {
                var btn = document.getElementById('day' + i + 'Btn');
                if (btn) {
                    btn.style.display = 'inline-block';
                }
            }
        }
        
        function initializeMap() {
            console.log("Initializing Google Maps");
            
            try {
                // Center map on Ring of Kerry area
                var mapCenter = { lat: 51.9, lng: -9.8 };
                
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 10,
                    center: mapCenter,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    styles: [
                        {
                            featureType: "poi",
                            elementType: "labels",
                            stylers: [{ visibility: "off" }]
                        }
                    ]
                });
                
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    suppressMarkers: true,
                    polylineOptions: {
                        strokeColor: "#4a7c59",
                        strokeWeight: 4,
                        strokeOpacity: 0.8
                    }
                });
                directionsRenderer.setMap(map);
                
                // Extract locations from itinerary and add to map
                extractLocationsFromItinerary();
                addMarkersToMap();
                
                console.log("Map initialized successfully");
                
            } catch (error) {
                console.error("Error initializing map:", error);
                showMapError();
            }
        }
        
        function extractLocationsFromItinerary() {
            console.log("Extracting locations from itinerary");
            extractedLocations = [];
            
            if (!currentItinerary) {
                // Fallback to basic Ring of Kerry route if no itinerary
                createBasicRingOfKerryRoute();
                return;
            }
            
            var dayLocations = {};
            var duration = parseInt(currentUserData.duration) || 3;
            
            // Parse itinerary by days
            var dayPattern = /day (\d+)[^]*?(?=day \d+|$)/gi;
            var dayMatches = currentItinerary.match(dayPattern);
            
            if (dayMatches && dayMatches.length > 0) {
                dayMatches.forEach(function(dayText, index) {
                    var dayNumber = index + 1;
                    dayLocations[dayNumber] = [];
                    
                    // Find locations mentioned in this day in order of appearance
                    var foundLocations = [];
                    for (var locationKey in ringOfKerryLocations) {
                        var position = dayText.toLowerCase().indexOf(locationKey);
                        if (position !== -1) {
                            var location = ringOfKerryLocations[locationKey];
                            foundLocations.push({
                                name: location.name,
                                lat: location.lat,
                                lng: location.lng,
                                day: dayNumber,
                                position: position
                            });
                        }
                    }
                    
                    // Sort by order of appearance in text
                    foundLocations.sort(function(a, b) {
                        return a.position - b.position;
                    });
                    
                    dayLocations[dayNumber] = foundLocations;
                });
            } else {
                // If no day pattern found, create logical Ring of Kerry route
                createBasicRingOfKerryRoute();
                return;
            }
            
            // Create logical routes for each day
            for (var day = 1; day <= duration; day++) {
                if (dayLocations[day] && dayLocations[day].length > 0) {
                    // Ensure logical flow - start with previous day's end if available
                    if (day > 1 && dayLocations[day-1] && dayLocations[day-1].length > 0) {
                        var previousEnd = dayLocations[day-1][dayLocations[day-1].length - 1];
                        // Check if current day starts near where previous day ended
                        var currentStart = dayLocations[day][0];
                        var distance = calculateDistance(previousEnd.lat, previousEnd.lng, currentStart.lat, currentStart.lng);
                        
                        // If too far apart, add connecting location
                        if (distance > 50) { // 50km threshold
                            var connectingLocation = findConnectingLocation(previousEnd, currentStart);
                            if (connectingLocation) {
                                dayLocations[day].unshift(connectingLocation);
                            }
                        }
                    }
                    
                    extractedLocations = extractedLocations.concat(dayLocations[day]);
                }
            }
            
            // If no locations found, create basic route
            if (extractedLocations.length === 0) {
                createBasicRingOfKerryRoute();
            }
            
            console.log("Extracted " + extractedLocations.length + " locations from itinerary");
        }
        
        function createBasicRingOfKerryRoute() {
            console.log("Creating basic Ring of Kerry route");
            var duration = parseInt(currentUserData.duration) || 3;
            
            // Standard Ring of Kerry routes based on duration
            var routes = {
                1: [
                    { name: 'Killarney', lat: 52.0599, lng: -9.5044, day: 1 },
                    { name: 'Ladies View', lat: 51.9967, lng: -9.5733, day: 1 },
                    { name: 'Molls Gap', lat: 51.9333, lng: -9.6333, day: 1 },
                    { name: 'Kenmare', lat: 51.8833, lng: -9.5833, day: 1 },
                    { name: 'Sneem', lat: 51.8333, lng: -9.9000, day: 1 },
                    { name: 'Waterville', lat: 51.8333, lng: -10.1667, day: 1 },
                    { name: 'Cahersiveen', lat: 51.9489, lng: -10.2225, day: 1 },
                    { name: 'Killorglin', lat: 52.1167, lng: -9.8000, day: 1 },
                    { name: 'Killarney', lat: 52.0599, lng: -9.5044, day: 1 }
                ],
                2: [
                    // Day 1: Killarney to Kenmare
                    { name: 'Killarney', lat: 52.0599, lng: -9.5044, day: 1 },
                    { name: 'Muckross House', lat: 52.0167, lng: -9.5167, day: 1 },
                    { name: 'Ladies View', lat: 51.9967, lng: -9.5733, day: 1 },
                    { name: 'Molls Gap', lat: 51.9333, lng: -9.6333, day: 1 },
                    { name: 'Kenmare', lat: 51.8833, lng: -9.5833, day: 1 },
                    
                    // Day 2: Kenmare around Ring back to Killarney
                    { name: 'Kenmare', lat: 51.8833, lng: -9.5833, day: 2 },
                    { name: 'Sneem', lat: 51.8333, lng: -9.9000, day: 2 },
                    { name: 'Waterville', lat: 51.8333, lng: -10.1667, day: 2 },
                    { name: 'Cahersiveen', lat: 51.9489, lng: -10.2225, day: 2 },
                    { name: 'Killorglin', lat: 52.1167, lng: -9.8000, day: 2 },
                    { name: 'Killarney', lat: 52.0599, lng: -9.5044, day: 2 }
                ],
                3: [
                    // Day 1: Killarney to Kenmare
                    { name: 'Killarney', lat: 52.0599, lng: -9.5044, day: 1 },
                    { name: 'Muckross House', lat: 52.0167, lng: -9.5167, day: 1 },
                    { name: 'Ladies View', lat: 51.9967, lng: -9.5733, day: 1 },
                    { name: 'Molls Gap', lat: 51.9333, lng: -9.6333, day: 1 },
                    { name: 'Kenmare', lat: 51.8833, lng: -9.5833, day: 1 },
                    
                    // Day 2: Kenmare to Waterville
                    { name: 'Kenmare', lat: 51.8833, lng: -9.5833, day: 2 },
                    { name: 'Staigue Fort', lat: 51.7833, lng: -9.9833, day: 2 },
                    { name: 'Derrynane Beach', lat: 51.7500, lng: -10.1167, day: 2 },
                    { name: 'Waterville', lat: 51.8333, lng: -10.1667, day: 2 },
                    
                    // Day 3: Waterville to Killarney
                    { name: 'Waterville', lat: 51.8333, lng: -10.1667, day: 3 },
                    { name: 'Portmagee', lat: 51.8833, lng: -10.3833, day: 3 },
                    { name: 'Cahersiveen', lat: 51.9489, lng: -10.2225, day: 3 },
                    { name: 'Killorglin', lat: 52.1167, lng: -9.8000, day: 3 },
                    { name: 'Killarney', lat: 52.0599, lng: -9.5044, day: 3 }
                ]
            };
            
            // Use route based on duration, fallback to 3-day route
            extractedLocations = routes[duration] || routes[3];
        }
        
        function calculateDistance(lat1, lng1, lat2, lng2) {
            var R = 6371; // Earth's radius in km
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLng = (lng2 - lng1) * Math.PI / 180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function findConnectingLocation(from, to) {
            // Find a logical connecting point between two locations
            var midLat = (from.lat + to.lat) / 2;
            var midLng = (from.lng + to.lng) / 2;
            
            // Find closest Ring of Kerry location to midpoint
            var closestLocation = null;
            var minDistance = Infinity;
            
            for (var key in ringOfKerryLocations) {
                var location = ringOfKerryLocations[key];
                var distance = calculateDistance(midLat, midLng, location.lat, location.lng);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestLocation = {
                        name: location.name,
                        lat: location.lat,
                        lng: location.lng,
                        day: to.day
                    };
                }
            }
            
            return closestLocation;
        }
        
        function addMarkersToMap() {
            console.log("Adding markers to map");
            
            if (!map || extractedLocations.length === 0) {
                console.log("No map or locations to display");
                return;
            }
            
            // Clear existing markers
            markers.forEach(function(marker) {
                marker.setMap(null);
            });
            markers = [];
            
            // Add markers for extracted locations
            extractedLocations.forEach(function(location, index) {
                var colorIndex = (location.day - 1) % routeColors.length;
                var color = routeColors[colorIndex];
                
                var marker = new google.maps.Marker({
                    position: { lat: location.lat, lng: location.lng },
                    map: map,
                    title: location.name,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: color,
                        fillOpacity: 0.8,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    },
                    day: location.day
                });
                
                // Add info window
                var infoWindow = new google.maps.InfoWindow({
                    content: '<div style="padding: 5px;"><strong>' + location.name + '</strong><br>Day ' + location.day + '</div>'
                });
                
                marker.addListener('click', function() {
                    infoWindow.open(map, marker);
                });
                
                markers.push(marker);
            });
            
            // Show route for all days initially
            showAllDaysRoute();
        }
        
        function showAllDaysRoute() {
            console.log("Showing complete tour route");
            
            if (!map || extractedLocations.length === 0) return;
            
            // Show all markers
            markers.forEach(function(marker) {
                marker.setVisible(true);
            });
            
            // Create complete tour route connecting all days
            var allLocations = [];
            var duration = parseInt(currentUserData.duration) || 3;
            
            for (var day = 1; day <= duration; day++) {
                var dayLocations = extractedLocations.filter(function(loc) {
                    return loc.day === day;
                });
                
                if (dayLocations.length > 0) {
                    allLocations = allLocations.concat(dayLocations);
                }
            }
            
            if (allLocations.length > 1) {
                // Remove duplicates (same location on consecutive days)
                var uniqueLocations = [];
                for (var i = 0; i < allLocations.length; i++) {
                    var current = allLocations[i];
                    var previous = allLocations[i - 1];
                    
                    if (!previous || 
                        calculateDistance(current.lat, current.lng, previous.lat, previous.lng) > 5) {
                        uniqueLocations.push(current);
                    }
                }
                
                createRoute(uniqueLocations, '#4a7c59', 'Complete Ring of Kerry Tour');
            }
            
            currentDayFilter = 'all';
            updateActiveMapButton('All Days');
        }
        
        function showDay(dayNumber) {
            console.log("Showing day " + dayNumber + " route");
            
            if (!map) return;
            
            // Hide all markers first
            markers.forEach(function(marker) {
                marker.setVisible(false);
            });
            
            // Show only markers for selected day
            var visibleMarkers = 0;
            markers.forEach(function(marker) {
                if (marker.day === dayNumber) {
                    marker.setVisible(true);
                    visibleMarkers++;
                }
            });
            
            // Create route for selected day only
            var dayLocations = extractedLocations.filter(function(loc) {
                return loc.day === dayNumber;
            });
            
            if (dayLocations.length > 1) {
                var routeColor = routeColors[dayNumber - 1] || '#4a7c59';
                createRoute(dayLocations, routeColor, 'Day ' + dayNumber + ' Route');
            } else if (dayLocations.length === 1) {
                // Single location - just center map on it
                map.setCenter({ lat: dayLocations[0].lat, lng: dayLocations[0].lng });
                map.setZoom(12);
            }
            
            console.log("Day " + dayNumber + ": showing " + visibleMarkers + " markers and " + dayLocations.length + " route points");
            
            currentDayFilter = dayNumber;
            updateActiveMapButton('Day ' + dayNumber);
        }
        
        function createRoute(locations, color, routeName) {
            if (!directionsService || !directionsRenderer || locations.length < 2) {
                console.log("Cannot create route: insufficient data");
                return;
            }
            
            console.log("Creating route: " + routeName + " with " + locations.length + " locations");
            
            var waypoints = locations.map(function(loc) {
                return { lat: loc.lat, lng: loc.lng };
            });
            
            // Limit waypoints to Google Maps API limits (max 25 waypoints including origin/destination)
            var maxWaypoints = 23; // 25 total - 2 for origin/destination
            if (waypoints.length > maxWaypoints + 2) {
                // Keep first, last, and evenly distributed points in between
                var step = Math.floor((waypoints.length - 2) / maxWaypoints);
                var reducedWaypoints = [waypoints[0]];
                
                for (var i = step; i < waypoints.length - 1; i += step) {
                    reducedWaypoints.push(waypoints[i]);
                }
                
                reducedWaypoints.push(waypoints[waypoints.length - 1]);
                waypoints = reducedWaypoints;
            }
            
            var request = {
                origin: waypoints[0],
                destination: waypoints[waypoints.length - 1],
                waypoints: waypoints.slice(1, -1).map(function(point) {
                    return { location: point, stopover: true };
                }),
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                region: 'IE',
                optimizeWaypoints: false // Keep order as specified
            };
            
            directionsRenderer.setOptions({
                polylineOptions: {
                    strokeColor: color,
                    strokeWeight: 4,
                    strokeOpacity: 0.8
                }
            });
            
            directionsService.route(request, function(result, status) {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    console.log("Route created successfully: " + routeName);
                    
                    // Show route info in console for debugging
                    var route = result.routes[0];
                    if (route && route.legs) {
                        var totalDistance = 0;
                        var totalDuration = 0;
                        route.legs.forEach(function(leg) {
                            totalDistance += leg.distance.value;
                            totalDuration += leg.duration.value;
                        });
                        console.log(routeName + " - Distance: " + (totalDistance / 1000).toFixed(1) + "km, Duration: " + Math.round(totalDuration / 60) + " minutes");
                    }
                } else {
                    console.error('Directions request failed for ' + routeName + ' due to ' + status);
                    
                    // Fallback: just show markers without route
                    if (locations.length > 0) {
                        var bounds = new google.maps.LatLngBounds();
                        locations.forEach(function(loc) {
                            bounds.extend({ lat: loc.lat, lng: loc.lng });
                        });
                        map.fitBounds(bounds);
                    }
                }
            });
        }
        
        function toggleSatellite() {
            if (!map) return;
            
            isSatelliteView = !isSatelliteView;
            var mapTypeId = isSatelliteView ? google.maps.MapTypeId.SATELLITE : google.maps.MapTypeId.ROADMAP;
            map.setMapTypeId(mapTypeId);
            
            var btn = document.getElementById('satelliteBtn');
            if (btn) {
                btn.textContent = isSatelliteView ? 'Road' : 'Satellite';
            }
        }
        
        function updateActiveMapButton(activeText) {
            var buttons = document.querySelectorAll('.map-btn');
            buttons.forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.textContent.trim() === activeText) {
                    btn.classList.add('active');
                }
            });
        }
        
        function showMapError() {
            var mapElement = document.getElementById('map');
            if (mapElement) {
                mapElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; text-align: center;"><div><div style="font-size: 3em; margin-bottom: 15px;">🗺️</div><h3>Map Unavailable</h3><p>Please add a valid Google Maps API key to enable the interactive map.</p></div></div>';
            }
        }
        
        function showError() {
            console.log("showError called");
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
        }
        
        function populateSummary(userData) {
            console.log("populateSummary called");
            
            var summaryElement = document.getElementById('tripSummary');
            var interests = userData && userData.interests ? userData.interests.join(', ') : 'general sightseeing';
            
            // Build the basic summary
            var summaryHTML = '<strong>' + userData.duration + '-Day Itinerary</strong> • ' + userData.travelMonth + ' 2025 • ' + userData.groupSize + ' people • €' + userData.budget + '/day budget<br>Interests: ' + interests;
            
            // Add special requirements section if any exist
            var specialRequirements = [];
            
            if (userData.dietaryRequirements) {
                specialRequirements.push('<span class="requirement-highlight dietary">🍽️ Dietary: ' + userData.dietaryRequirements + '</span>');
            }
            
            if (userData.accessibilityNeeds) {
                specialRequirements.push('<span class="requirement-highlight accessibility">♿ Accessibility: ' + userData.accessibilityNeeds + '</span>');
            }
            
            if (userData.specialRequests) {
                specialRequirements.push('<span class="requirement-highlight special">✨ Special Requests: ' + userData.specialRequests + '</span>');
            }
            
            if (userData.pace && userData.pace !== 'moderate') {
                var paceDisplay = userData.pace.charAt(0).toUpperCase() + userData.pace.slice(1) + ' pace';
                specialRequirements.push('<span class="requirement-highlight style">🎯 Travel Style: ' + paceDisplay + '</span>');
            }
            
            // Display accommodation type preference
            if (userData.accommodation && userData.accommodation !== 'flexible') {
                var accommodationDisplay = getAccommodationDisplayName(userData.accommodation);
                specialRequirements.push('<span class="requirement-highlight accommodation">🏨 Accommodation: ' + accommodationDisplay + '</span>');
            }
            
            // Add special requirements to summary if any exist
            if (specialRequirements.length > 0) {
                summaryHTML += '<div class="special-requirements-section">';
                summaryHTML += '<div class="requirements-title">✅ Your specific requirements have been incorporated:</div>';
                summaryHTML += '<div class="requirements-list">' + specialRequirements.join('') + '</div>';
                summaryHTML += '<div class="requirements-note">Every recommendation below has been carefully selected to accommodate these needs.</div>';
                summaryHTML += '</div>';
            }
            
            summaryElement.innerHTML = summaryHTML;
        }
        
        // Function to convert accommodation values to display names
        function getAccommodationDisplayName(accommodationType) {
            var displayNames = {
                'self-catering': 'Self-Catering Properties',
                'bed-breakfast': 'Bed & Breakfast',
                '3-4-star-hotels': '3-4 Star Hotels',
                '5-star-luxury': '5-Star Luxury',
                'flexible': 'Flexible'
            };
            return displayNames[accommodationType] || accommodationType;
        }
        
        function populateItinerary(itinerary) {
            console.log("populateItinerary called");
            
            var contentElement = document.getElementById('itineraryContent');
            
            if (!itinerary) {
                contentElement.innerHTML = '<p>No itinerary content available.</p>';
                return;
            }
            
            var formattedItinerary = itinerary;
            
            // Remove AI continuation messages that shouldn't be shown to users
            formattedItinerary = formattedItinerary.replace(/\[Continues with[^[\]]*\]/gi, '');
            formattedItinerary = formattedItinerary.replace(/\[.*character limit.*\]/gi, '');
            formattedItinerary = formattedItinerary.replace(/Would you like me to[^?]*\?/gi, '');
            formattedItinerary = formattedItinerary.replace(/\(Note:[^)]*\)/gi, '');
            
            // First, convert **bold** to styled strong tags (before adding <br> tags)
            formattedItinerary = formattedItinerary.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert "DAY X:" patterns to h2 headers (before <br> conversion)
            formattedItinerary = formattedItinerary.replace(/^(DAY \d+[^\n]*)/gm, '<h2>$1</h2>');
            
            // Convert "ACCOMMODATION FOR TONIGHT:" patterns to special h3 headers
            formattedItinerary = formattedItinerary.replace(/^(ACCOMMODATION FOR TONIGHT:)/gm, '<h3 style="background: #e8f5e8; color: #2d5a3d; border-left-color: #4a7c59;">🏨 $1</h3>');
            
            // Remove the dashed lines that follow day headers (they're just visual clutter now)
            formattedItinerary = formattedItinerary.replace(/^-{20,}$/gm, '<div style="height: 2px; background: linear-gradient(90deg, #4a7c59, transparent); margin: 20px 0;"></div>');
            
            // Convert "MORNING:", "AFTERNOON:", "EVENING:" to h3 headers (before <br> conversion)
            formattedItinerary = formattedItinerary.replace(/^(MORNING|AFTERNOON|EVENING):$/gm, '<h3>🕒 $1</h3>');
            
            // Convert time patterns like "8:00 AM" etc to h3 headers
            formattedItinerary = formattedItinerary.replace(/^(\d{1,2}:\d{2}\s*[AP]M[^\n]*)/gm, '<h3>🕒 $1</h3>');
            
            // Style accommodation recommendations within content
            formattedItinerary = formattedItinerary.replace(/🏨 \*\*Recommendation \d+:\*\*/g, '<div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #4a7c59; border-radius: 8px;"><strong style="color: #2d5a3d; font-size: 1.1em;">🏨 Accommodation Option:</strong>');
            
            // Close accommodation recommendation divs
            formattedItinerary = formattedItinerary.replace(/(\- \*\*Contact:\*\*[^\n]+)/g, '$1</div>');
            
            // Clean up any remaining incomplete sections
            formattedItinerary = formattedItinerary.replace(/\[.*?\]/g, ''); // Remove any remaining [bracketed] content
            
            // Now convert line breaks to HTML
            formattedItinerary = formattedItinerary.replace(/\n/g, '<br>');
            
            // Clean up excessive line breaks
            formattedItinerary = formattedItinerary.replace(/(<br>\s*){3,}/g, '<br><br>');
            
            console.log("Formatted itinerary:", formattedItinerary.substring(0, 500));
            
            contentElement.innerHTML = formattedItinerary;
        }
        
        function showShareModal() {
            console.log("showShareModal called");
            var modal = document.getElementById('shareModal');
            var shareUrl = document.getElementById('shareUrl');
            
            if (itineraryId) {
                var url = window.location.origin + '/planner/itinerary.html?id=' + itineraryId;
                shareUrl.textContent = url;
            } else {
                shareUrl.textContent = 'Shareable link not available for this itinerary';
            }
            
            modal.style.display = 'block';
        }
        
        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
        }
        
        function copyShareLink() {
            var shareUrl = document.getElementById('shareUrl').textContent;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareUrl).then(function() {
                    alert('Link copied to clipboard!');
                    closeShareModal();
                }).catch(function() {
                    alert('Unable to copy link. Please copy manually.');
                });
            } else {
                alert('Unable to copy link. Please copy manually.');
            }
        }
        
        function showDownloadOptions() {
            console.log("showDownloadOptions called");
            document.getElementById('downloadModal').style.display = 'block';
        }
        
        function closeDownloadModal() {
            document.getElementById('downloadModal').style.display = 'none';
        }
        
        function downloadAsPDF() {
            console.log("downloadAsPDF called");
            var printContent = createPrintableContent();
            var newWindow = window.open('', '_blank');
            if (newWindow) {
                var htmlContent = '<!DOCTYPE html><html><head><title>Ring of Kerry Itinerary</title><style>body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; } h1 { color: #2d5a3d; text-align: center; } h2 { color: #4a7c59; border-bottom: 2px solid #4a7c59; padding-bottom: 5px; } h3 { color: #2d5a3d; } .summary { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }</style></head><body>' + printContent + '</body></html>';
                newWindow.document.write(htmlContent);
                newWindow.document.close();
                newWindow.print();
            }
            closeDownloadModal();
        }
        
        function downloadAsText() {
            console.log("downloadAsText called");
            var textContent = createTextContent();
            var blob = new Blob([textContent], { type: 'text/plain' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'ring-of-kerry-itinerary.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            closeDownloadModal();
        }
        
        function emailItinerary() {
            console.log("emailItinerary called");
            var textContent = createTextContent();
            var subject = encodeURIComponent('My Ring of Kerry Itinerary');
            var body = encodeURIComponent(textContent);
            var mailtoLink = 'mailto:?subject=' + subject + '&body=' + body;
            window.location.href = mailtoLink;
            closeDownloadModal();
        }
        
        function createPrintableContent() {
            var userData = currentUserData;
            var interests = userData && userData.interests ? userData.interests.join(', ') : 'general sightseeing';
            
            var content = '<h1>🍀 Your Ring of Kerry Adventure</h1>';
            content += '<div class="summary">';
            content += '<strong>' + userData.duration + '-Day Itinerary</strong> • ' + userData.travelMonth + ' 2025 • ' + userData.groupSize + ' people • €' + userData.budget + '/day budget<br>';
            content += 'Interests: ' + interests;
            
            // Add accommodation preference to printable content
            if (userData.accommodation && userData.accommodation !== 'flexible') {
                content += '<br>Accommodation Preference: ' + getAccommodationDisplayName(userData.accommodation);
            }
            
            // Add special requirements to printable content
            if (userData.dietaryRequirements || userData.accessibilityNeeds || userData.specialRequests) {
                content += '<br><strong>Special Requirements:</strong>';
                if (userData.dietaryRequirements) {
                    content += '<br>• Dietary: ' + userData.dietaryRequirements;
                }
                if (userData.accessibilityNeeds) {
                    content += '<br>• Accessibility: ' + userData.accessibilityNeeds;
                }
                if (userData.specialRequests) {
                    content += '<br>• Special Requests: ' + userData.specialRequests;
                }
            }
            
            content += '</div>';
            content += document.getElementById('itineraryContent').innerHTML;
            content += '<hr style="margin: 30px 0;">';
            content += '<p><em>Generated by Ring of Kerry Tours - ringofkerrytours.com</em></p>';
            
            return content;
        }
        
        function createTextContent() {
            var userData = currentUserData;
            var interests = userData && userData.interests ? userData.interests.join(', ') : 'general sightseeing';
            
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = currentItinerary;
            var plainText = tempDiv.textContent || tempDiv.innerText || '';
            
            var content = 'RING OF KERRY ADVENTURE\n';
            content += userData.duration + '-Day Itinerary • ' + userData.travelMonth + ' 2025 • ' + userData.groupSize + ' people • €' + userData.budget + '/day budget\n';
            content += 'Interests: ' + interests + '\n';
            
            // Add accommodation preference to text content
            if (userData.accommodation && userData.accommodation !== 'flexible') {
                content += 'Accommodation Preference: ' + getAccommodationDisplayName(userData.accommodation) + '\n';
            }
            
            // Add special requirements to text content
            if (userData.dietaryRequirements || userData.accessibilityNeeds || userData.specialRequests) {
                content += '\nSPECIAL REQUIREMENTS:\n';
                if (userData.dietaryRequirements) {
                    content += '• Dietary: ' + userData.dietaryRequirements + '\n';
                }
                if (userData.accessibilityNeeds) {
                    content += '• Accessibility: ' + userData.accessibilityNeeds + '\n';
                }
                if (userData.specialRequests) {
                    content += '• Special Requests: ' + userData.specialRequests + '\n';
                }
            }
            
            content += '\n' + plainText + '\n\n';
            content += 'Generated by Ring of Kerry Tours - ringofkerrytours.com';
            
            return content;
        }
        
        function printItinerary() {
            console.log("printItinerary called");
            window.print();
        }
        
        window.onclick = function(event) {
            var shareModal = document.getElementById('shareModal');
            var downloadModal = document.getElementById('downloadModal');
            
            if (event.target === shareModal) {
                shareModal.style.display = 'none';
            }
            if (event.target === downloadModal) {
                downloadModal.style.display = 'none';
            }
        };
        
        console.log("Script loaded successfully");
    </script>
</body>
</html>
